<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aircraft Maintenance History Ledger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Web3.js for blockchain interaction -->
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.8.1/dist/web3.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <!-- CRITICAL FIX: Load the application logic file -->
    <script src="app.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .container-main { max-width: 900px; }
        .tab-content table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .tab-content th, .tab-content td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; }
        .tab-content th { background-color: #f3f4f6; font-weight: 600; }
        /* Custom Button Styling */
        .btn-primary { 
            background-color: #4f46e5; 
            color: white; 
            font-weight: 600; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            transition: background-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }

        .btn-secondary { 
            background-color: #10b981; 
            color: white; 
            font-weight: 600; 
            padding: 0.75rem 1.5rem; 
            border-radius: 0.5rem; 
            transition: background-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover:not(:disabled) { background-color: #059669; }
        .btn-secondary:disabled { background-color: #a7f3d0; cursor: not-allowed; }

    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="container-main mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
            Aircraft Maintenance History Ledger (BNB Testnet)
        </h1>

        <!-- Wallet Status Area -->
        <div class="card p-4 mb-8 bg-indigo-50 border border-indigo-200">
            <h2 class="text-lg font-bold text-indigo-700 mb-2">Wallet & Network Status</h2>
            <p id="accountStatus" class="text-sm text-gray-700 break-words">Account (Connected): Awaiting Connection...</p>
            <p id="networkStatus" class="text-sm text-gray-700">Network ID: Awaiting Connection...</p>
            <p id="balanceStatus" class="text-sm text-gray-700">Balance: 0 tBNB</p>
            <p class="text-xs text-red-500 mt-2">ðŸš¨ Ensure your connected address is the Admin address (from your Truffle Mnemonic).</p>
        </div>

        <!-- Tab Navigation -->
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tabUpload" onclick="setActiveTab('upload')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    1. Upload & Record
                </button>
                <button id="tabView" onclick="setActiveTab('view')" class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    2. View & Analyze Record
                </button>
            </nav>
        </div>

        <!-- Tab Content: UPLOAD & RECORD -->
        <div id="contentUpload" class="tab-content card p-6 mt-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Record New Maintenance Data</h2>

            <div class="space-y-4 mb-6">
                <!-- Pinata Keys -->
                <div>
                    <label for="apiKey" class="block text-sm font-medium text-gray-700">Pinata API Key</label>
                    <input type="password" id="apiKey" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Your Pinata API Key">
                </div>
                <div>
                    <label for="apiSecret" class="block text-sm font-medium text-gray-700">Pinata Secret Key</label>
                    <input type="password" id="apiSecret" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="Your Pinata Secret Key">
                </div>

                <!-- File Input -->
                <div>
                    <label for="fileInput" class="block text-sm font-medium text-gray-700">Select Maintenance CSV File</label>
                    <input type="file" id="fileInput" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                <!-- Step 1 Button: IPFS Upload -->
                <button id="ipfsUploadButton" onclick="handleIpfsUpload()" class="btn-primary flex-1">
                    1. Upload File to IPFS
                </button>
                
                <!-- Step 2 Button: Blockchain Record -->
                <button id="recordOnlyButton" onclick="handleRecordOnly()" class="btn-secondary flex-1" disabled>
                    2. Record CID on Blockchain
                </button>
            </div>


            <!-- Status Display -->
            <div id="uploadStatus" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 min-h-[4rem]">
                Status: Ready to upload.
            </div>
            
            <!-- IPFS Hash Display -->
            <div id="ipfsHashDisplay" class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-xs font-mono break-all hidden">
                Last Uploaded CID: 
            </div>
        </div>

        <!-- Tab Content: VIEW & ANALYZE -->
        <div id="contentView" class="tab-content card p-6 mt-6 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Retrieve and Analyze Record</h2>
            
            <div class="flex space-x-4 mb-6">
                <input type="number" id="recordIdInput" class="flex-1 border border-gray-300 rounded-md shadow-sm p-2" placeholder="Enter Maintenance Record ID (e.g., 1)">
                <button id="viewButton" onclick="viewRecordAndAnalyze()" class="btn-primary w-1/3">
                    Retrieve Record and Start Analysis
                </button>
            </div>

            <!-- Status Display -->
            <div id="viewStatus" class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm font-medium text-gray-700 min-h-[4rem]">
                Status: Enter a Record ID and click 'Retrieve'.
            </div>

            <!-- Data Table -->
            <div class="mt-8 overflow-x-auto">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Raw Maintenance Data (from IPFS)</h3>
                <div id="dataTable" class="card overflow-hidden">
                    <p class="p-4 text-gray-500">Data will appear here after retrieval.</p>
                </div>
            </div>
            
            <!-- Chart Area -->
            <div class="mt-8 card p-4">
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Residual Value Trend Analysis</h3>
                <canvas id="residualValueChart"></canvas>
            </div>
        </div>
        
    </div>
</body>
</html>
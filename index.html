<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroChain | FAA-Compliant Maintenance Records</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .loading-spinner {
            border: 3px solid #f3f4f6; border-top: 3px solid #2563eb;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">A</div>
                    <span class="text-xl font-bold tracking-tight text-slate-800">AeroChain</span>
                </div>
                <div id="walletInfo" class="flex items-center space-x-3 text-sm font-medium text-slate-600 bg-slate-100 px-4 py-2 rounded-full border border-slate-200">
                    <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse" id="statusDot"></div>
                    <span id="walletAddress">Connect Wallet</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg text-sm font-medium shadow-sm fade-in border"></div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <!-- Record Entry -->
                <section class="glass-card rounded-2xl border border-slate-200 shadow-sm p-6">
                    <h2 class="text-lg font-bold mb-4 text-slate-800 flex items-center italic">Secure New Log</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Asset Model</label>
                            <select id="aircraftTypeSelect" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl bg-white outline-none">
                                <option value="B787">Boeing 787-9 ($190M)</option>
                                <option value="B737 NG">Boeing 737 NG ($80M)</option>
                                <option value="A320 Family">Airbus A320 Family ($77M)</option>
                                <option value="B777">Boeing 777 ($140M)</option>
                                <option value="A330">Airbus A330 ($175M)</option>
                                <option value="B767">Boeing 767 ($150M)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tail Number</label>
                            <input type="text" id="aircraftTailNo" placeholder="N770ER" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Cloud Authorization (Pinata)</label>
                            <input type="password" id="pinataApiKey" placeholder="API Key" class="w-full px-4 py-2 mb-2 border border-slate-200 rounded-xl text-xs">
                            <input type="password" id="pinataApiSecret" placeholder="Secret Key" class="w-full px-4 py-2 border border-slate-200 rounded-xl text-xs">
                        </div>
                        <div class="p-4 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition-colors cursor-pointer text-center" onclick="document.getElementById('maintenanceFile').click()">
                            <input type="file" id="maintenanceFile" accept=".csv" class="hidden">
                            <p id="fileNameDisplay" class="text-xs text-slate-400 font-medium">Click to Attach Maintenance CSV</p>
                        </div>
                        <button onclick="handleUpload()" id="uploadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                            Verify & Secure Asset
                        </button>
                    </div>
                </section>

                <!-- Search -->
                <section class="glass-card rounded-2xl border border-slate-200 shadow-sm p-6">
                    <h2 class="text-lg font-bold mb-4 text-slate-800 flex items-center italic">Search Registry</h2>
                    <div class="flex space-x-2 mb-3">
                        <input type="number" id="searchQuery" placeholder="Enter Record ID (1, 2, 3...)" min="1" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl outline-none text-sm">
                        <button onclick="searchByRecordId()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 rounded-xl font-bold transition-all">Go</button>
                    </div>
                    <div id="searchResultMeta" class="hidden p-4 bg-indigo-50 border border-indigo-100 rounded-xl fade-in text-[11px] leading-relaxed"></div>
                    <div class="mt-3 text-[10px] text-slate-400">
                        <p>üí° Enter the Record ID number (IDs start from 1)</p>
                        <p class="mt-1">You'll receive a Record ID when you upload a new maintenance log.</p>
                    </div>
                </section>

                <!-- Stats -->
                <section class="glass-card rounded-2xl border border-slate-200 shadow-sm p-6">
                    <h2 class="text-lg font-bold mb-4 text-slate-800">Chain Statistics</h2>
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-xl">
                        <span class="text-sm font-medium text-purple-900">Total Records</span>
                        <span id="totalRecords" class="text-lg font-bold text-purple-700">-</span>
                    </div>
                </section>
            </div>

            <!-- Dashboard -->
            <div class="lg:col-span-8 space-y-6">
                <div id="dataDashboard" class="hidden space-y-6">
                    <!-- Info Card -->
                    <div class="glass-card border border-blue-100 rounded-xl p-6 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold text-blue-900" id="displayTailNumber">-</h3>
                                <p class="text-sm text-slate-600" id="displayModel">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-500">Current RV</p>
                                <p class="text-2xl font-bold text-green-600" id="currentRV">$0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <section class="glass-card rounded-2xl border border-slate-200 shadow-sm p-6">
                        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Residual Value Curve (USD)</h2>
                        <div class="h-[350px]">
                            <canvas id="rvChart"></canvas>
                        </div>
                    </section>

                    <!-- Table -->
                    <section class="glass-card rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-slate-50 px-6 py-3 border-b flex justify-between items-center">
                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Compliance Ledger</div>
                            <button onclick="downloadCSV()" class="text-xs bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                                üì• Download CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto max-h-[500px]" id="tableWrapper"></div>
                    </section>

                    <!-- IPFS Links -->
                    <section id="ipfsLinks" class="glass-card border border-blue-100 rounded-xl p-6 shadow-sm hidden">
                        <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">Blockchain Proof</h2>
                        <div class="space-y-2">
                            <a id="rawCsvLink" href="#" target="_blank" class="block p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-sm text-blue-700 font-medium transition-colors">
                                üìÑ View Original CSV (IPFS)
                            </a>
                            <a id="processedCsvLink" href="#" target="_blank" class="block p-3 bg-green-50 hover:bg-green-100 rounded-lg text-sm text-green-700 font-medium transition-colors">
                                üìä View Processed Data (IPFS)
                            </a>
                        </div>
                    </section>
                </div>

                <div id="emptyState" class="flex flex-col items-center justify-center py-32 bg-white border border-dashed border-slate-200 rounded-3xl">
                    <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mb-4 text-slate-300">‚úàÔ∏è</div>
                    <h3 class="text-slate-800 font-bold">No Data Loaded</h3>
                    <p class="text-slate-400 text-sm">Connect wallet and enter search query above.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="loadingModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center max-w-xs w-full">
            <div class="loading-spinner mb-4"></div>
            <h3 id="loadingTitle" class="text-lg font-bold">Syncing</h3>
            <p id="loadingMessage" class="text-xs text-slate-500 text-center mt-2 leading-relaxed"></p>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const CONTRACT_ADDRESS = "0xf0Ac7007BCf7b9aaDE8fFc261937c4f56228d442";
        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"address[]","name":"_admins","type":"address[]"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"fileId","type":"uint256"},{"indexed":false,"internalType":"string","name":"ipfsHash","type":"string"}],"name":"FileHashRecorded","type":"event"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"fileHashes","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function","constant":true},
            {"inputs":[{"internalType":"string","name":"_ipfsHash","type":"string"}],"name":"addFileHash","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_fileId","type":"uint256"}],"name":"getFileHash","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function","constant":true}
        ];
        
        const AIRCRAFT_PARAMS = {
            "B787": { initialPrice: 190000000, permDepr: 1185.36, varDepr: 2406.64, econRate: 0.04 },
            "B737 NG": { initialPrice: 80000000, permDepr: 715.61, varDepr: 1452.90, econRate: 0.04 },
            "A320 Family": { initialPrice: 77000000, permDepr: 796.79, varDepr: 1617.72, econRate: 0.04 },
            "B777": { initialPrice: 140000000, permDepr: 1568.66, varDepr: 3184.85, econRate: 0.04 },
            "A330": { initialPrice: 175000000, permDepr: 1291.46, varDepr: 2622.05, econRate: 0.04 },
            "B767": { initialPrice: 150000000, permDepr: 1101.38, varDepr: 2236.13, econRate: 0.04 }
        };

        const IPFS_GATEWAYS = [
            "https://gateway.pinata.cloud/ipfs/",
            "https://ipfs.io/ipfs/",
            "https://cloudflare-ipfs.com/ipfs/"
        ];

        let web3, contract, chartInstance, currentData = null;

        // =============================================
        // INITIALIZATION
        // =============================================
        async function initWeb3() {
            if (!window.ethereum) {
                notify("error", "MetaMask not detected. Please install MetaMask.");
                return;
            }

            web3 = new Web3(window.ethereum);
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                
                const shortAddr = accounts[0].substring(0, 6) + '...' + accounts[0].substring(38);
                document.getElementById('walletAddress').textContent = shortAddr;
                document.getElementById('statusDot').className = "w-2 h-2 rounded-full bg-green-500";
                
                await updateTotalRecords();
                notify("success", "Wallet connected successfully!");

                // Listen for account changes
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());
            } catch (e) {
                notify("error", "Wallet connection denied.");
                console.error(e);
            }
        }

        // =============================================
        // UPLOAD HANDLER
        // =============================================
        async function handleUpload() {
            const tail = document.getElementById('aircraftTailNo').value.trim();
            const type = document.getElementById('aircraftTypeSelect').value;
            const file = document.getElementById('maintenanceFile').files[0];
            const key = document.getElementById('pinataApiKey').value.trim();
            const secret = document.getElementById('pinataApiSecret').value.trim();

            // Validation
            if (!tail) {
                notify("error", "Please enter tail number.");
                return;
            }
            if (!file) {
                notify("error", "Please select a CSV file.");
                return;
            }
            if (!key || !secret) {
                notify("error", "Please enter Pinata API credentials.");
                return;
            }
            if (!contract) {
                notify("error", "Please connect MetaMask first.");
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;

            try {
                // Step 1: Read and parse CSV
                showLoading("CSV Parser", "Reading maintenance records...");
                const csvText = await readFileAsText(file);
                const parsedCsv = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                
                if (parsedCsv.errors.length > 0) {
                    throw new Error('CSV parsing error: ' + parsedCsv.errors[0].message);
                }

                // Step 2: Upload raw CSV to IPFS
                showLoading("IPFS Upload (1/2)", "Publishing original documentation...");
                const rawCid = await uploadToPinata(file, key, secret);
                notify("success", `‚úì Raw CSV uploaded: ${rawCid.substring(0, 12)}...`);

                // Step 3: Calculate RV
                showLoading("RV Calculator", "Analyzing depreciation and maintenance reserves...");
                const params = AIRCRAFT_PARAMS[type];
                const processedData = calculateRV(parsedCsv.data, params);

                // Step 4: Upload processed data to IPFS
                showLoading("IPFS Upload (2/2)", "Publishing processed valuation...");
                const processedCsv = Papa.unparse(processedData);
                const processedBlob = new Blob([processedCsv], { type: 'text/csv' });
                const processedFile = new File([processedBlob], `PROCESSED_${tail}_${Date.now()}.csv`, { type: 'text/csv' });
                const processedCid = await uploadToPinata(processedFile, key, secret);
                notify("success", `‚úì Processed data uploaded: ${processedCid.substring(0, 12)}...`);

                // Step 5: Record on blockchain
                showLoading("Blockchain Writer", "Creating immutable record pointer...");
                const metadata = `${tail.toUpperCase()}|${rawCid}|${processedCid}|${type}`;
                const accounts = await web3.eth.getAccounts();
                
                const gasEstimate = await contract.methods.addFileHash(metadata).estimateGas({ from: accounts[0] });
                const receipt = await contract.methods.addFileHash(metadata).send({ 
                    from: accounts[0],
                    gas: Math.floor(gasEstimate * 1.2)
                });

                hideLoading();
                
                const recordId = receipt.events.FileHashRecorded.returnValues.fileId;
                
                // Show prominent success message with Record ID
                notify("success", `‚úÖ SUCCESS! Your maintenance log has been secured on the blockchain.`);
                
                // Display Record ID prominently
                setTimeout(() => {
                    const el = document.getElementById('statusMessage');
                    el.className = `mb-6 p-6 rounded-xl text-sm font-medium fade-in border bg-green-50 text-green-900 border-green-200`;
                    el.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="text-2xl">‚úÖ</div>
                            <div class="flex-1">
                                <p class="font-bold text-lg mb-2">Record Successfully Created!</p>
                                <div class="bg-white border border-green-200 rounded-lg p-4 mb-3">
                                    <p class="text-xs text-green-700 mb-1">YOUR RECORD ID:</p>
                                    <p class="text-3xl font-black text-green-900 font-mono">${recordId}</p>
                                </div>
                                <p class="text-xs text-green-700">Aircraft: <span class="font-bold">${tail}</span> | Model: <span class="font-bold">${type}</span></p>
                                <p class="text-xs text-green-600 mt-2">üí° Save this Record ID to retrieve your data later!</p>
                            </div>
                        </div>
                    `;
                    el.classList.remove('hidden');
                }, 100);

                // Display results
                displayResults(processedData, tail, type, rawCid, processedCid);
                await updateTotalRecords();

                // Reset form
                document.getElementById('maintenanceFile').value = '';
                document.getElementById('fileNameDisplay').textContent = 'Click to Attach Maintenance CSV';

            } catch (err) {
                hideLoading();
                notify("error", "Upload failed: " + err.message);
                console.error(err);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // =============================================
        // SEARCH HANDLER (Record ID Only)
        // =============================================
        async function searchByRecordId() {
            const query = document.getElementById('searchQuery').value.trim();
            if (!query) {
                notify("error", "Please enter a Record ID.");
                return;
            }
            if (!contract) {
                notify("error", "Please connect MetaMask first.");
                return;
            }

            const recordId = parseInt(query);
            if (isNaN(recordId) || recordId < 1) {
                notify("error", "Please enter a valid Record ID (must be 1 or higher).");
                return;
            }

            try {
                showLoading("Blockchain Query", `Fetching Record ID ${recordId}...`);
                
                // Fetch metadata from blockchain
                let metadata;
                try {
                    metadata = await contract.methods.getFileHash(recordId).call();
                    if (!metadata || metadata === '') {
                        throw new Error(`Record ID ${recordId} does not exist.`);
                    }
                } catch (e) {
                    throw new Error(`Record ID ${recordId} not found. Please check the ID and try again.`);
                }

                // Parse metadata
                const parts = metadata.split('|');
                if (parts.length < 3) {
                    throw new Error('Corrupted metadata format.');
                }

                const [tail, rawCid, processedCid, type] = parts;

                // Display search result
                document.getElementById('searchResultMeta').classList.remove('hidden');
                document.getElementById('searchResultMeta').innerHTML = `
                    <p class="font-bold text-indigo-900 mb-2">‚úàÔ∏è Aircraft: ${tail} ${type ? `(${type})` : ''}</p>
                    <p class="text-indigo-700 mb-3 font-mono text-xs">Record ID: ${recordId}</p>
                    <div class="flex flex-col gap-2">
                        <a href="${IPFS_GATEWAYS[0]}${rawCid}" target="_blank" class="text-indigo-500 hover:text-indigo-700 underline text-xs">üìÑ View Original CSV (IPFS)</a>
                        <a href="${IPFS_GATEWAYS[0]}${processedCid}" target="_blank" class="text-indigo-500 hover:text-indigo-700 underline text-xs">üìä View Processed Valuation (IPFS)</a>
                    </div>
                `;

                // Fetch processed data from IPFS
                showLoading("IPFS Network", "Retrieving processed data from distributed storage...");
                const csvText = await fetchFromIPFS(processedCid);
                const parsed = Papa.parse(csvText.trim(), { header: true, skipEmptyLines: true });
                
                if (parsed.errors.length > 0) {
                    console.warn('CSV parsing warnings:', parsed.errors);
                }

                hideLoading();
                displayResults(parsed.data, tail, type || 'Unknown', rawCid, processedCid);
                notify("success", `‚úì Loaded Record ID ${recordId}: ${tail}`);

            } catch (e) {
                hideLoading();
                notify("error", e.message);
                document.getElementById('searchResultMeta').classList.add('hidden');
                console.error('Search error:', e);
            }
        }

        // =============================================
        // RV CALCULATION
        // =============================================
        function calculateRV(csvData, params) {
            // Find required columns (flexible matching)
            const headers = Object.keys(csvData[0] || {});
            const dateCol = headers.find(h => h.toLowerCase().includes('date'));
            const tisCol = headers.find(h => h.toLowerCase().includes('tis') || h.toLowerCase().includes('total') || h.toLowerCase().includes('airframe'));
            const workCol = headers.find(h => h.toLowerCase().includes('work') || h.toLowerCase().includes('type') || h.toLowerCase().includes('note'));

            if (!dateCol || !tisCol) {
                throw new Error('CSV must contain Date and TIS columns');
            }

            let currentRV = params.initialPrice;
            let maintenanceReserve = 0;
            let lastTis = 0;

            const results = [];

            for (let i = 0; i < csvData.length; i++) {
                const row = csvData[i];
                const date = row[dateCol] || '';
                const tis = parseFloat(row[tisCol]) || 0;
                const workType = row[workCol] || '';

                // Calculate depreciation
                const deltaTis = tis - lastTis;
                if (deltaTis > 0) {
                    const physicalDepr = deltaTis * params.permDepr;
                    const economicDepr = (params.initialPrice * params.econRate) * (deltaTis / 2000);
                    const totalDepr = physicalDepr + economicDepr;
                    
                    currentRV -= totalDepr;
                    maintenanceReserve += (deltaTis * params.varDepr);
                }

                let remarks = '';
                // Check if major maintenance (Check event)
                if (workType.toLowerCase().includes('check') && maintenanceReserve > 0) {
                    currentRV += maintenanceReserve;
                    remarks = `+$${Math.round(maintenanceReserve).toLocaleString()} (MR Recaptured)`;
                    maintenanceReserve = 0;
                }

                results.push({
                    Date: date,
                    TIS: Math.round(tis),
                    Work: workType,
                    RV: Math.max(0, Math.round(currentRV)),
                    MR: Math.round(maintenanceReserve),
                    Remarks: remarks
                });

                lastTis = tis;
            }

            return results;
        }

        // =============================================
        // IPFS FUNCTIONS
        // =============================================
        async function uploadToPinata(file, apiKey, apiSecret) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
                method: 'POST',
                headers: {
                    'pinata_api_key': apiKey,
                    'pinata_secret_api_key': apiSecret
                },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error('Pinata upload failed: ' + (error.error || 'Authentication error'));
            }

            const result = await response.json();
            return result.IpfsHash;
        }

        async function fetchFromIPFS(cid) {
            let lastError = null;
            
            for (let gateway of IPFS_GATEWAYS) {
                try {
                    console.log(`Trying gateway: ${gateway}`);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
                    
                    const response = await fetch(`${gateway}${cid}`, {
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const text = await response.text();
                        console.log(`‚úì Successfully fetched from ${gateway}`);
                        return text;
                    } else {
                        console.warn(`Gateway ${gateway} returned status ${response.status}`);
                    }
                } catch (e) {
                    console.warn(`Gateway ${gateway} failed:`, e.message);
                    lastError = e;
                }
            }
            
            throw new Error('Failed to fetch from IPFS. All gateways timed out or failed. Please try again.');
        }

        // =============================================
        // DISPLAY FUNCTIONS
        // =============================================
        function displayResults(data, tailNo, model, rawCid, processedCid) {
            currentData = data;
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('dataDashboard').classList.remove('hidden');

            // Update info card
            document.getElementById('displayTailNumber').textContent = tailNo;
            document.getElementById('displayModel').textContent = `${model} | ${data.length} records`;
            
            const latestRV = data[data.length - 1]?.RV || 0;
            document.getElementById('currentRV').textContent = '$' + latestRV.toLocaleString();

            // Render table
            renderTable(data);

            // Render chart
            renderChart(data);

            // Show IPFS links
            if (rawCid && processedCid) {
                document.getElementById('ipfsLinks').classList.remove('hidden');
                document.getElementById('rawCsvLink').href = `${IPFS_GATEWAYS[0]}${rawCid}`;
                document.getElementById('processedCsvLink').href = `${IPFS_GATEWAYS[0]}${processedCid}`;
            }
        }

        function renderTable(data) {
            let html = `<table class="min-w-full text-[10px]">
                <thead class="bg-slate-50 border-b sticky top-0">
                    <tr>
                        <th class="p-4 text-left font-bold text-slate-400 uppercase">Date</th>
                        <th class="p-4 text-left font-bold text-slate-400 uppercase">TIS</th>
                        <th class="p-4 text-left font-bold text-slate-400 uppercase">Work</th>
                        <th class="p-4 text-left font-bold text-blue-600 uppercase">RV (USD)</th>
                        <th class="p-4 text-left font-bold text-red-400 uppercase">MR Fund</th>
                        <th class="p-4 text-left font-bold text-slate-400 uppercase">Audit Notes</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">`;
            
            data.forEach((r, idx) => {
                const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                html += `<tr class="${bgClass} hover:bg-blue-50 transition-colors">
                    <td class="p-4">${r.Date}</td>
                    <td class="p-4 font-mono">${r.TIS.toLocaleString()}</td>
                    <td class="p-4">${r.Work}</td>
                    <td class="p-4 font-bold text-blue-800">$${r.RV.toLocaleString()}</td>
                    <td class="p-4 text-slate-600">$${r.MR.toLocaleString()}</td>
                    <td class="p-4 font-medium text-emerald-600">${r.Remarks || '-'}</td>
                </tr>`;
            });
            
            document.getElementById('tableWrapper').innerHTML = html + "</tbody></table>";
        }

        function renderChart(data) {
            const ctx = document.getElementById('rvChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.Date),
                    datasets: [{
                        label: 'Residual Value',
                        data: data.map(d => d.RV),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'RV: $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        async function updateTotalRecords() {
            try {
                let count = 0;
                let id = 1;
                
                while (id < 10000) {
                    try {
                        const hash = await contract.methods.fileHashes(id).call();
                        if (!hash || hash === '') break;
                        count++;
                        id++;
                    } catch (e) {
                        break;
                    }
                }
                
                document.getElementById('totalRecords').textContent = count;
            } catch (error) {
                console.error('Error fetching total records:', error);
                document.getElementById('totalRecords').textContent = '0';
            }
        }

        function downloadCSV() {
            if (!currentData) {
                notify("error", "No data to download");
                return;
            }
            
            const csv = Papa.unparse(currentData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aircraft_rv_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            notify("success", "CSV downloaded successfully!");
        }

        function notify(type, msg) {
            const el = document.getElementById('statusMessage');
            const colors = {
                'success': 'bg-emerald-50 text-emerald-800 border-emerald-200',
                'error': 'bg-rose-50 text-rose-800 border-rose-200',
                'info': 'bg-blue-50 text-blue-800 border-blue-200'
            };
            
            el.className = `mb-6 p-4 rounded-xl text-sm font-medium fade-in border ${colors[type] || colors.info}`;
            el.textContent = msg;
            el.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => el.classList.add('hidden'), 5000);
            }
        }

        function showLoading(title, message) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        document.getElementById('maintenanceFile').addEventListener('change', (e) => {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'Click to Attach Maintenance CSV';
            document.getElementById('fileNameDisplay').textContent = fileName;
        });

        // =============================================
        // INITIALIZE
        // =============================================
        window.addEventListener('load', initWeb3);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroChain | í•­ê³µê¸° ì •ë¹„ ê¸°ë¡ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.1/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen text-slate-900 font-sans">

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-900 to-blue-800 text-white p-4 shadow-xl">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                </svg>
                <span class="text-2xl font-black tracking-tight">AeroChain</span>
            </div>
            <div class="flex items-center space-x-4">
                <div id="networkInfo" class="text-xs bg-blue-800 px-3 py-1.5 rounded-full border border-blue-700">
                    <span id="networkName">ì—°ê²° ëŒ€ê¸°ì¤‘...</span>
                </div>
                <div id="walletInfo" class="text-xs font-mono bg-blue-800 px-3 py-1.5 rounded-full border border-blue-700">
                    <span id="walletAddress">ì§€ê°‘ ì—°ê²°...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Status Notification -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg text-sm font-medium shadow-lg fade-in"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Upload & Search -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Upload Section -->
                <section class="glass-card border border-blue-100 rounded-xl p-6 shadow-lg">
                    <h2 class="text-lg font-bold mb-4 flex items-center text-blue-900">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        ì •ë¹„ ê¸°ë¡ ì—…ë¡œë“œ
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2">í•­ê³µê¸° ë“±ë¡ë²ˆí˜¸ (Tail Number)</label>
                            <input type="text" id="aircraftId" placeholder="ì˜ˆ: N300SH, HL7737" 
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all">
                            <p class="text-xs text-slate-500 mt-1">* í•„ìˆ˜ ì…ë ¥</p>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2">í•­ê³µê¸° ëª¨ë¸</label>
                            <select id="aircraftModel" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="B737">Boeing 737</option>
                                <option value="B777">Boeing 777</option>
                                <option value="B787">Boeing 787</option>
                                <option value="A320">Airbus A320</option>
                                <option value="A350">Airbus A350</option>
                                <option value="DEFAULT">ê¸°íƒ€</option>
                            </select>
                        </div>

                        <div class="border-t pt-4">
                            <label class="block text-xs font-bold text-slate-600 mb-2">Pinata API Key</label>
                            <input type="password" id="pinataApiKey" placeholder="API í‚¤ ì…ë ¥"
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2">Pinata Secret Key</label>
                            <input type="password" id="pinataApiSecret" placeholder="Secret í‚¤ ì…ë ¥"
                                   class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 mb-2">ì •ë¹„ ê¸°ë¡ íŒŒì¼ (CSV)</label>
                            <input type="file" id="maintenanceFile" accept=".csv" 
                                   class="w-full text-sm text-slate-600 file:mr-4 file:py-2.5 file:px-5 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer border border-dashed border-slate-300 rounded-lg p-2">
                            <p class="text-xs text-slate-500 mt-2">í•„ìˆ˜ ì»¬ëŸ¼: Date, TIS (Total In Service), Work Type</p>
                        </div>

                        <button onclick="handleUpload()" id="uploadBtn" 
                                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3.5 rounded-lg transition-all shadow-lg hover:shadow-xl active:transform active:scale-98 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="uploadBtnText">ë¸”ë¡ì²´ì¸ì— ê¸°ë¡í•˜ê¸°</span>
                        </button>
                    </div>
                </section>

                <!-- Search Section -->
                <section class="glass-card border border-green-100 rounded-xl p-6 shadow-lg">
                    <h2 class="text-lg font-bold mb-4 flex items-center text-green-900">
                        <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ê¸°ë¡ ê²€ìƒ‰
                    </h2>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="searchQuery" placeholder="ë“±ë¡ë²ˆí˜¸ ë˜ëŠ” Record ID" 
                                   class="flex-1 p-3 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <button onclick="searchRecord()" 
                                    class="bg-green-600 hover:bg-green-700 text-white px-6 rounded-lg text-sm font-bold transition-all shadow-md">
                                ê²€ìƒ‰
                            </button>
                        </div>
                        <div id="searchResult" class="hidden"></div>
                        
                        <div class="text-xs text-slate-500 bg-slate-50 p-3 rounded-lg border border-slate-200">
                            <p class="font-semibold mb-1">ğŸ’¡ ê²€ìƒ‰ ë°©ë²•</p>
                            <p>â€¢ ë“±ë¡ë²ˆí˜¸: N737CL, HL7737 ë“±</p>
                            <p>â€¢ Record ID: 1, 2, 3 ë“± (1ë¶€í„° ì‹œì‘)</p>
                        </div>
                    </div>
                </section>

                <!-- Stats Section -->
                <section class="glass-card border border-purple-100 rounded-xl p-6 shadow-lg">
                    <h2 class="text-lg font-bold mb-4 text-purple-900">í†µê³„</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <span class="text-sm font-medium text-purple-900">ì „ì²´ ê¸°ë¡ ìˆ˜</span>
                            <span id="totalRecords" class="text-lg font-bold text-purple-700">-</span>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Visualization & Data -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Results Area -->
                <div id="resultsArea" class="hidden space-y-6 fade-in">
                    <!-- Aircraft Info Card -->
                    <div class="glass-card border border-blue-100 rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-2xl font-bold text-blue-900" id="displayTailNumber">-</h3>
                                <p class="text-sm text-slate-600" id="displayModel">-</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-slate-500">í˜„ì¬ RV</p>
                                <p class="text-2xl font-bold text-green-600" id="currentRV">$0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <section class="glass-card border border-blue-100 rounded-xl p-6 shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-sm font-bold text-slate-600 uppercase tracking-widest">ì”ì¡´ ê°€ì¹˜ (Residual Value) ì¶”ì´</h2>
                            <div class="flex gap-2">
                                <button onclick="downloadChart()" class="text-xs bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-colors">
                                    ğŸ“Š ì°¨íŠ¸ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                        <div class="h-[400px]">
                            <canvas id="rvChart"></canvas>
                        </div>
                    </section>

                    <!-- Data Table Section -->
                    <section class="glass-card border border-blue-100 rounded-xl shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-slate-50 to-blue-50 px-6 py-4 border-b flex justify-between items-center">
                            <h2 class="text-sm font-bold text-slate-700 uppercase">ìƒì„¸ ì •ë¹„ ê¸°ë¡</h2>
                            <button onclick="downloadCSV()" class="text-xs bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                                ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <div id="tableContainer" class="overflow-x-auto max-h-[600px] overflow-y-auto">
                            <!-- Dynamic Table -->
                        </div>
                    </section>

                    <!-- IPFS Links Section -->
                    <section id="ipfsLinks" class="glass-card border border-blue-100 rounded-xl p-6 shadow-lg hidden">
                        <h2 class="text-sm font-bold text-slate-700 uppercase mb-4">ë¸”ë¡ì²´ì¸ ì¦ëª…</h2>
                        <div class="space-y-2">
                            <a id="rawCsvLink" href="#" target="_blank" class="block p-3 bg-blue-50 hover:bg-blue-100 rounded-lg text-sm text-blue-700 font-medium transition-colors">
                                ğŸ“„ ì›ë³¸ CSV íŒŒì¼ ë³´ê¸° (IPFS)
                            </a>
                            <a id="processedCsvLink" href="#" target="_blank" class="block p-3 bg-green-50 hover:bg-green-100 rounded-lg text-sm text-green-700 font-medium transition-colors">
                                ğŸ“Š ì²˜ë¦¬ëœ ë°ì´í„° ë³´ê¸° (IPFS)
                            </a>
                            <div id="blockchainTxLink" class="p-3 bg-purple-50 rounded-lg text-xs text-purple-700">
                                <p class="font-semibold mb-1">íŠ¸ëœì­ì…˜ í•´ì‹œ:</p>
                                <p id="txHash" class="font-mono break-all">-</p>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="flex flex-col items-center justify-center py-32 text-center space-y-6">
                    <div class="bg-gradient-to-br from-blue-100 to-blue-200 p-8 rounded-full shadow-lg">
                        <svg class="w-16 h-16 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-800">í•­ê³µê¸° ì •ë¹„ ê¸°ë¡ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                    <p class="text-slate-600 max-w-2xl leading-relaxed">
                        MetaMask ì§€ê°‘ì„ ì—°ê²°í•˜ê³  CSV ì •ë¹„ ê¸°ë¡ì„ ì—…ë¡œë“œí•˜ì—¬<br>
                        ë¸”ë¡ì²´ì¸ ê¸°ë°˜ìœ¼ë¡œ í•­ê³µê¸° ì”ì¡´ ê°€ì¹˜(RV)ë¥¼ ê³„ì‚°í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8 max-w-4xl">
                        <div class="p-6 bg-white rounded-xl shadow-md border border-blue-100">
                            <div class="text-3xl mb-3">ğŸ”</div>
                            <h3 class="font-bold text-slate-800 mb-2">ë¸”ë¡ì²´ì¸ ê¸°ë°˜</h3>
                            <p class="text-sm text-slate-600">ë³€ì¡° ë¶ˆê°€ëŠ¥í•œ ì•ˆì „í•œ ê¸°ë¡ ê´€ë¦¬</p>
                        </div>
                        <div class="p-6 bg-white rounded-xl shadow-md border border-green-100">
                            <div class="text-3xl mb-3">ğŸ“Š</div>
                            <h3 class="font-bold text-slate-800 mb-2">ìë™ RV ê³„ì‚°</h3>
                            <p class="text-sm text-slate-600">ì‹¤ì‹œê°„ ì”ì¡´ ê°€ì¹˜ ë¶„ì„</p>
                        </div>
                        <div class="p-6 bg-white rounded-xl shadow-md border border-purple-100">
                            <div class="text-3xl mb-3">ğŸ”</div>
                            <h3 class="font-bold text-slate-800 mb-2">ë¹ ë¥¸ ê²€ìƒ‰</h3>
                            <p class="text-sm text-slate-600">ê³¼ê±° ê¸°ë¡ ì¦‰ì‹œ ì¡°íšŒ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Modal -->
    <div id="loadingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 shadow-2xl text-center max-w-md">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="loadingTitle">ì²˜ë¦¬ ì¤‘...</h3>
            <p class="text-sm text-slate-600" id="loadingMessage">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const CONFIG = {
            CONTRACT_ADDRESS: "0xf0Ac7007BCf7b9aaDE8fFc261937c4f56228d442",
            CONTRACT_ABI: [
                {"inputs":[{"internalType":"address[]","name":"_admins","type":"address[]"}],"stateMutability":"nonpayable","type":"constructor"},
                {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"fileId","type":"uint256"},{"indexed":false,"internalType":"string","name":"ipfsHash","type":"string"},{"indexed":false,"internalType":"address","name":"uploader","type":"address"}],"name":"FileHashRecorded","type":"event"},
                {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"fileHashes","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function","constant":true},
                {"inputs":[{"internalType":"string","name":"_ipfsHash","type":"string"}],"name":"addFileHash","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
                {"inputs":[{"internalType":"uint256","name":"_fileId","type":"uint256"}],"name":"getFileHash","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function","constant":true}
            ],
            PINATA_URL: 'https://api.pinata.cloud/pinning/pinFileToIPFS',
            EXPECTED_NETWORK: '0x61', // BSC Testnet
            NETWORK_NAME: 'BSC Testnet',
            AIRCRAFT_PARAMS: {
                "B787": { initialPrice: 248000000, permDepr: 1185.36, varDepr: 2406.64, annualEconRate: 0.04 },
                "B737": { initialPrice: 102000000, permDepr: 715.61, varDepr: 1452.90, annualEconRate: 0.04 },
                "A320": { initialPrice: 101000000, permDepr: 796.79, varDepr: 1617.72, annualEconRate: 0.04 },
                "B777": { initialPrice: 320000000, permDepr: 1568.66, varDepr: 3184.85, annualEconRate: 0.04 },
                "A350": { initialPrice: 317000000, permDepr: 1450.00, varDepr: 2950.00, annualEconRate: 0.04 },
                "DEFAULT": { initialPrice: 100000000, permDepr: 800.00, varDepr: 1600.00, annualEconRate: 0.04 }
            }
        };

        // =============================================
        // GLOBAL STATE
        // =============================================
        let web3, contract, chartInstance, currentData = null;

        // =============================================
        // INITIALIZATION
        // =============================================
        async function initWeb3() {
            try {
                if (!window.ethereum) {
                    showStatus('MetaMaskë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!', 'error');
                    return;
                }

                web3 = new Web3(window.ethereum);
                
                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Check network
                const chainId = await web3.eth.getChainId();
                const chainIdHex = '0x' + chainId.toString(16);
                
                if (chainIdHex !== CONFIG.EXPECTED_NETWORK) {
                    showStatus(`ì˜ëª»ëœ ë„¤íŠ¸ì›Œí¬ì…ë‹ˆë‹¤. ${CONFIG.NETWORK_NAME}ì— ì—°ê²°í•´ì£¼ì„¸ìš”.`, 'error');
                    document.getElementById('networkName').textContent = 'ì˜ëª»ëœ ë„¤íŠ¸ì›Œí¬';
                    return;
                }

                // Initialize contract
                contract = new web3.eth.Contract(CONFIG.CONTRACT_ABI, CONFIG.CONTRACT_ADDRESS);
                
                // Update UI
                const shortAddress = accounts[0].substring(0, 6) + '...' + accounts[0].substring(38);
                document.getElementById('walletAddress').textContent = shortAddress;
                document.getElementById('networkName').textContent = CONFIG.NETWORK_NAME;
                
                // Load total records
                await updateTotalRecords();
                
                showStatus('ì§€ê°‘ ì—°ê²° ì™„ë£Œ!', 'success');

                // Listen for account changes
                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());

            } catch (error) {
                console.error('Web3 initialization error:', error);
                showStatus('ì§€ê°‘ ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // =============================================
        // UPLOAD HANDLER
        // =============================================
        async function handleUpload() {
            const tailNo = document.getElementById('aircraftId').value.trim();
            const model = document.getElementById('aircraftModel').value;
            const fileInput = document.getElementById('maintenanceFile');
            const apiKey = document.getElementById('pinataApiKey').value.trim();
            const apiSecret = document.getElementById('pinataApiSecret').value.trim();

            // Validation
            if (!tailNo) {
                showStatus('í•­ê³µê¸° ë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!fileInput.files[0]) {
                showStatus('CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!apiKey || !apiSecret) {
                showStatus('Pinata API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!contract) {
                showStatus('ë¨¼ì € MetaMaskë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const file = fileInput.files[0];
            const uploadBtn = document.getElementById('uploadBtn');
            
            try {
                // Disable button
                uploadBtn.disabled = true;
                document.getElementById('uploadBtnText').textContent = 'ì²˜ë¦¬ ì¤‘...';

                // Step 1: Parse CSV
                showLoading('CSV íŒŒì¼ ë¶„ì„ ì¤‘...', 'íŒŒì¼ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤.');
                const csvText = await readFileAsText(file);
                const parsedCsv = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                
                if (parsedCsv.errors.length > 0) {
                    throw new Error('CSV íŒŒì‹± ì˜¤ë¥˜: ' + parsedCsv.errors[0].message);
                }

                // Step 2: Upload original CSV to IPFS
                showLoading('IPFS ì—…ë¡œë“œ ì¤‘... (1/2)', 'ì›ë³¸ CSVë¥¼ ì—…ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                const rawCid = await uploadToIPFS(file, apiKey, apiSecret);
                showStatus(`âœ“ ì›ë³¸ CSV ì—…ë¡œë“œ ì™„ë£Œ (CID: ${rawCid.substring(0, 10)}...)`, 'success');

                // Step 3: Calculate RV
                showLoading('RV ê³„ì‚° ì¤‘...', 'ì”ì¡´ ê°€ì¹˜ë¥¼ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                const params = CONFIG.AIRCRAFT_PARAMS[model] || CONFIG.AIRCRAFT_PARAMS.DEFAULT;
                const processedData = calculateRV(parsedCsv.data, params);

                // Step 4: Upload processed data to IPFS
                showLoading('IPFS ì—…ë¡œë“œ ì¤‘... (2/2)', 'ì²˜ë¦¬ëœ ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  ìˆìŠµë‹ˆë‹¤.');
                const processedCsv = jsonToCsv(processedData);
                const processedBlob = new Blob([processedCsv], { type: 'text/csv' });
                const processedFile = new File([processedBlob], `PROCESSED_${tailNo}_${Date.now()}.csv`, { type: 'text/csv' });
                const processedCid = await uploadToIPFS(processedFile, apiKey, apiSecret);
                showStatus(`âœ“ ì²˜ë¦¬ëœ ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ (CID: ${processedCid.substring(0, 10)}...)`, 'success');

                // Step 5: Record on blockchain
                showLoading('ë¸”ë¡ì²´ì¸ ê¸°ë¡ ì¤‘...', 'MetaMaskì—ì„œ íŠ¸ëœì­ì…˜ì„ ìŠ¹ì¸í•´ì£¼ì„¸ìš”.');
                const metadata = `${tailNo.toUpperCase()}|${model}|${rawCid}|${processedCid}`;
                const accounts = await web3.eth.getAccounts();
                
                // Estimate gas
                const gasEstimate = await contract.methods.addFileHash(metadata).estimateGas({ from: accounts[0] });
                
                const receipt = await contract.methods.addFileHash(metadata).send({ 
                    from: accounts[0],
                    gas: Math.floor(gasEstimate * 1.2) // Add 20% buffer
                });

                hideLoading();

                // Get record ID from event
                const recordId = receipt.events.FileHashRecorded.returnValues.fileId;
                const txHash = receipt.transactionHash;

                showStatus(`âœ… ì„±ê³µ! Record ID: ${recordId} | TX: ${txHash.substring(0, 10)}...`, 'success');

                // Display results
                displayResults(processedData, tailNo, model, rawCid, processedCid, txHash);
                
                // Update stats
                await updateTotalRecords();

                // Reset form
                fileInput.value = '';

            } catch (error) {
                console.error('Upload error:', error);
                hideLoading();
                showStatus('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            } finally {
                uploadBtn.disabled = false;
                document.getElementById('uploadBtnText').textContent = 'ë¸”ë¡ì²´ì¸ì— ê¸°ë¡í•˜ê¸°';
            }
        }

        // =============================================
        // SEARCH HANDLER
        // =============================================
        async function searchRecord() {
            const query = document.getElementById('searchQuery').value.trim();
            const resultDiv = document.getElementById('searchResult');

            if (!query) {
                showStatus('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!contract) {
                showStatus('ë¨¼ì € MetaMaskë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showLoading('ê²€ìƒ‰ ì¤‘...', `"${query}"ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.`);
                
                let metadata = "";
                let foundId = null;

                // Check if query is numeric (Record ID) or string (Tail Number)
                if (!isNaN(query)) {
                    // Direct ID search
                    foundId = query;
                    try {
                        metadata = await contract.methods.getFileHash(query).call();
                        if (!metadata || metadata === '') {
                            throw new Error(`Record ID ${query}ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                        }
                    } catch (e) {
                        throw new Error(`Record ID ${query}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. IDëŠ” 1ë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤.`);
                    }
                } else {
                    // Search by tail number - scan blockchain records
                    const queryUpper = query.toUpperCase();
                    let searchId = 1; // Smart contracts usually start from 1
                    let found = false;
                    
                    // Try sequential search (more reliable than events)
                    while (searchId < 1000) { // Safety limit
                        try {
                            const hash = await contract.methods.fileHashes(searchId).call();
                            if (!hash || hash === '') break; // No more records
                            
                            if (hash.startsWith(queryUpper + '|')) {
                                foundId = searchId;
                                metadata = hash;
                                found = true;
                                break;
                            }
                            searchId++;
                        } catch (e) {
                            // Record doesn't exist, stop searching
                            break;
                        }
                    }

                    if (!found) {
                        throw new Error('í•´ë‹¹ ë“±ë¡ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }

                hideLoading();

                // Parse metadata
                const parts = metadata.split('|');
                if (parts.length < 4) {
                    throw new Error('ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.');
                }

                const [tailNo, model, rawCid, processedCid] = parts;

                // Display search result
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="p-4 bg-white border-2 border-green-200 rounded-lg shadow-md fade-in">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="font-bold text-lg text-green-900">âœˆï¸ ${tailNo}</span>
                                <span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${model}</span>
                            </div>
                            <span class="text-xs text-slate-500">Record ID: ${foundId}</span>
                        </div>
                        <div class="flex flex-col gap-2">
                            <a href="https://gateway.pinata.cloud/ipfs/${rawCid}" target="_blank" 
                               class="text-xs text-blue-600 hover:text-blue-800 underline">ğŸ“„ ì›ë³¸ CSV ë³´ê¸°</a>
                            <a href="https://gateway.pinata.cloud/ipfs/${processedCid}" target="_blank" 
                               class="text-xs text-green-600 hover:text-green-800 underline">ğŸ“Š ì²˜ë¦¬ëœ ë°ì´í„° ë³´ê¸°</a>
                        </div>
                    </div>
                `;

                // Fetch and display processed data
                showLoading('ë°ì´í„° ë¡œë”© ì¤‘...', 'IPFSì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.');
                const response = await fetch(`https://gateway.pinata.cloud/ipfs/${processedCid}`);
                const csvText = await response.text();
                const processedData = parseProcessedCsv(csvText);
                
                hideLoading();
                displayResults(processedData, tailNo, model, rawCid, processedCid);
                showStatus(`âœ“ "${query}" ê²€ìƒ‰ ì™„ë£Œ!`, 'success');

            } catch (error) {
                console.error('Search error:', error);
                hideLoading();
                showStatus('ê²€ìƒ‰ ì‹¤íŒ¨: ' + error.message, 'error');
                resultDiv.classList.add('hidden');
            }
        }

        // =============================================
        // RV CALCULATION
        // =============================================
        function calculateRV(csvData, params) {
            // Find required columns
            const headers = Object.keys(csvData[0] || {});
            const dateCol = headers.find(h => h.toLowerCase().includes('date'));
            const tisCol = headers.find(h => h.toLowerCase().includes('tis') || h.toLowerCase().includes('total'));
            const workCol = headers.find(h => h.toLowerCase().includes('work') || h.toLowerCase().includes('type'));

            if (!dateCol || !tisCol) {
                throw new Error('CSVì— í•„ìˆ˜ ì»¬ëŸ¼(Date, TIS)ì´ ì—†ìŠµë‹ˆë‹¤.');
            }

            let currentRV = params.initialPrice;
            let maintenanceReserve = 0;
            let lastTis = 0;

            const results = [];

            for (let i = 0; i < csvData.length; i++) {
                const row = csvData[i];
                const date = row[dateCol] || '';
                const tis = parseFloat(row[tisCol]) || 0;
                const workType = row[workCol] || '';

                // Calculate depreciation
                const deltaTis = tis - lastTis;
                if (deltaTis > 0) {
                    const physicalDepr = deltaTis * params.permDepr;
                    const economicDepr = (params.initialPrice * params.annualEconRate) * (deltaTis / 2000);
                    const totalDepr = physicalDepr + economicDepr;
                    
                    currentRV -= totalDepr;
                    maintenanceReserve += (deltaTis * params.varDepr);
                }

                let note = '';
                // Check if major maintenance (Check event)
                if (workType.toLowerCase().includes('check') && maintenanceReserve > 0) {
                    currentRV += maintenanceReserve;
                    note = `MR ë³µêµ¬: $${maintenanceReserve.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                    maintenanceReserve = 0;
                }

                results.push({
                    date: date,
                    tis: tis,
                    workType: workType,
                    rv: Math.max(0, currentRV), // RV cannot be negative
                    mr: maintenanceReserve,
                    note: note
                });

                lastTis = tis;
            }

            return results;
        }

        // =============================================
        // IPFS UPLOAD
        // =============================================
        async function uploadToIPFS(file, apiKey, apiSecret) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(CONFIG.PINATA_URL, {
                method: 'POST',
                headers: {
                    'pinata_api_key': apiKey,
                    'pinata_secret_api_key': apiSecret
                },
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error('IPFS ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (error.error || 'Unknown error'));
            }

            const result = await response.json();
            return result.IpfsHash;
        }

        // =============================================
        // DISPLAY FUNCTIONS
        // =============================================
        function displayResults(data, tailNo, model, rawCid, processedCid, txHash = null) {
            currentData = data;
            
            // Hide welcome screen, show results
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('resultsArea').classList.remove('hidden');

            // Update aircraft info
            document.getElementById('displayTailNumber').textContent = tailNo;
            document.getElementById('displayModel').textContent = `${model} | ${data.length} records`;
            
            const latestRV = data[data.length - 1]?.rv || 0;
            document.getElementById('currentRV').textContent = '$' + latestRV.toLocaleString(undefined, {maximumFractionDigits: 0});

            // Render table
            renderTable(data);

            // Render chart
            renderChart(data);

            // Show IPFS links if available
            if (rawCid && processedCid) {
                const linksSection = document.getElementById('ipfsLinks');
                linksSection.classList.remove('hidden');
                
                document.getElementById('rawCsvLink').href = `https://gateway.pinata.cloud/ipfs/${rawCid}`;
                document.getElementById('processedCsvLink').href = `https://gateway.pinata.cloud/ipfs/${processedCid}`;
                
                if (txHash) {
                    document.getElementById('txHash').textContent = txHash;
                }
            }
        }

        function renderTable(data) {
            let html = `
                <table class="min-w-full text-xs">
                    <thead class="bg-slate-100 border-b-2 border-slate-200 sticky top-0">
                        <tr>
                            <th class="p-3 text-left font-bold text-slate-700">ë‚ ì§œ</th>
                            <th class="p-3 text-left font-bold text-slate-700">TIS (hrs)</th>
                            <th class="p-3 text-left font-bold text-slate-700">ì‘ì—… ë‚´ìš©</th>
                            <th class="p-3 text-left font-bold text-blue-700">RV (USD)</th>
                            <th class="p-3 text-left font-bold text-orange-700">MR Balance</th>
                            <th class="p-3 text-left font-bold text-slate-700">ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach((row, idx) => {
                const bgClass = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                html += `
                    <tr class="${bgClass} border-b border-slate-200 hover:bg-blue-50 transition-colors">
                        <td class="p-3">${row.date}</td>
                        <td class="p-3 font-mono">${row.tis.toLocaleString()}</td>
                        <td class="p-3">${row.workType}</td>
                        <td class="p-3 font-bold text-blue-700">$${row.rv.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="p-3 font-mono text-orange-600">$${row.mr.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="p-3 text-green-600 italic">${row.note}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        function renderChart(data) {
            const ctx = document.getElementById('rvChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: 'Residual Value (USD)',
                        data: data.map(d => d.rv),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return 'RV: $' + context.parsed.y.toLocaleString(undefined, {maximumFractionDigits: 0});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
                reader.readAsText(file);
            });
        }

        function jsonToCsv(data) {
            const headers = ['Date', 'TIS', 'WorkType', 'RV', 'MR', 'Note'];
            const rows = data.map(row => [
                row.date,
                row.tis,
                `"${row.workType}"`,
                row.rv,
                row.mr,
                `"${row.note}"`
            ].join(','));
            
            return [headers.join(','), ...rows].join('\n');
        }

        function parseProcessedCsv(csvText) {
            const lines = csvText.trim().split('\n');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) { // Skip header
                const match = lines[i].match(/([^,]+),([^,]+),"([^"]*)",([^,]+),([^,]+),"([^"]*)"/);
                if (match) {
                    data.push({
                        date: match[1],
                        tis: parseFloat(match[2]),
                        workType: match[3],
                        rv: parseFloat(match[4]),
                        mr: parseFloat(match[5]),
                        note: match[6]
                    });
                }
            }
            
            return data;
        }

        async function updateTotalRecords() {
            try {
                let count = 0;
                let id = 1; // Start from 1
                
                // Sequential scan
                while (id < 10000) { // Safety limit
                    try {
                        const hash = await contract.methods.fileHashes(id).call();
                        if (!hash || hash === '') break;
                        count++;
                        id++;
                    } catch (e) {
                        // No more records
                        break;
                    }
                }
                
                document.getElementById('totalRecords').textContent = count;
            } catch (error) {
                console.error('Error fetching total records:', error);
                document.getElementById('totalRecords').textContent = '0';
            }
        }

        function downloadCSV() {
            if (!currentData) return;
            
            const csv = jsonToCsv(currentData);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aircraft_rv_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
        }

        function downloadChart() {
            if (!chartInstance) return;
            
            const url = chartInstance.toBase64Image();
            const a = document.createElement('a');
            a.href = url;
            a.download = `rv_chart_${Date.now()}.png`;
            a.click();
            
            showStatus('ì°¨íŠ¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!', 'success');
        }

        // =============================================
        // UI HELPERS
        // =============================================
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.classList.remove('hidden');
            
            const colors = {
                'success': 'bg-green-100 text-green-800 border border-green-200',
                'error': 'bg-red-100 text-red-800 border border-red-200',
                'info': 'bg-blue-100 text-blue-800 border border-blue-200'
            };
            
            statusEl.className = `mb-6 p-4 rounded-lg text-sm font-medium shadow-lg fade-in ${colors[type] || colors.info}`;
            statusEl.textContent = message;
            
            // Auto hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 5000);
            }
        }

        function showLoading(title, message) {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }

        // =============================================
        // INITIALIZE ON PAGE LOAD
        // =============================================
        document.addEventListener('DOMContentLoaded', () => {
            initWeb3();
        });
    </script>
</body>
</html>
